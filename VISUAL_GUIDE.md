# 🎨 Визуальное руководство CS2 Judge Bot

## 📊 Архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                      TELEGRAM BOT API                        │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                         MAIN.PY                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Bot + Dispatcher Setup                  │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────┬──────────────────┬──────────────────┬───────────┘
            │                  │                  │
            ↓                  ↓                  ↓
┌───────────────────┐  ┌──────────────┐  ┌──────────────────┐
│   MIDDLEWARES     │  │   HANDLERS   │  │     SCHEDULER    │
│ ┌───────────────┐ │  │              │  │  ┌────────────┐  │
│ │ Auth          │ │  │ player.py    │  │  │ Auto-close │  │
│ │ Role Check    │ │  │ judge.py     │  │  │ tickets    │  │
│ │ Rate Limiting │ │  │ admin.py     │  │  │ (3 days)   │  │
│ └───────────────┘ │  │              │  │  └────────────┘  │
└─────────┬─────────┘  └──────┬───────┘  └────────┬─────────┘
          │                   │                   │
          └───────────────────┼───────────────────┘
                              ↓
                    ┌──────────────────┐
                    │   DATABASE (DB)  │
                    │                  │
                    │  ┌────────────┐  │
                    │  │ users      │  │
                    │  │ tickets    │  │
                    │  │ comments   │  │
                    │  └────────────┘  │
                    └──────────────────┘
```

---

## 🔄 Поток данных при создании заявки

```
┌─────────────┐
│   Игрок     │
│ /start      │
└──────┬──────┘
       │
       ↓
┌─────────────────────────────────────┐
│ AuthMiddleware                      │
│ - Проверка user в БД                │
│ - Регистрация если нет              │
│ - Добавление user в контекст        │
└──────────────┬──────────────────────┘
               │
               ↓
┌─────────────────────────────────────┐
│ RateLimitMiddleware                 │
│ - Проверка количества запросов      │
│ - Блокировка если > 10/мин          │
└──────────────┬──────────────────────┘
               │
               ↓
┌─────────────────────────────────────┐
│ Handler: cmd_start                  │
│ - Показывает главное меню           │
│ - Inline кнопки (создать/просмотр)  │
└──────────────┬──────────────────────┘
               │
               ↓ [Нажимает "Создать жалобу"]
               │
┌─────────────────────────────────────┐
│ FSM: TicketForm.choosing_type       │
│ - Показывает типы жалоб             │
│ - 3 inline кнопки                   │
└──────────────┬──────────────────────┘
               │
               ↓ [Выбирает тип]
               │
┌─────────────────────────────────────┐
│ FSM: TicketForm.entering_description│
│ - Ожидает текст описания            │
│ - Сохраняет тип в FSM context       │
└──────────────┬──────────────────────┘
               │
               ↓ [Вводит описание]
               │
┌─────────────────────────────────────┐
│ Валидация                           │
│ - Минимум 10 символов               │
│ - Максимум 1000 символов            │
└──────────────┬──────────────────────┘
               │
               ↓ [Валидация OK]
               │
┌─────────────────────────────────────┐
│ FSM: TicketForm.confirming          │
│ - Показывает превью                 │
│ - Кнопки: Отправить/Отмена          │
└──────────────┬──────────────────────┘
               │
               ↓ [Подтверждает]
               │
┌─────────────────────────────────────┐
│ Database.create_ticket()            │
│ - INSERT INTO tickets               │
│ - Возвращает ticket объект          │
└──────────────┬──────────────────────┘
               │
               ↓
      ┌────────┴────────┐
      │                 │
      ↓                 ↓
┌──────────┐    ┌──────────────┐
│ Игроку:  │    │ Всем судьям: │
│ ✅ Заявка│    │ 🔔 Новая     │
│ создана  │    │ заявка #N    │
└──────────┘    └──────────────┘
```

---

## 👨‍⚖️ Поток обработки заявки судьей

```
┌─────────────┐
│   Судья     │
│ Все заявки  │
└──────┬──────┘
       │
       ↓
┌─────────────────────────────────────┐
│ RoleMiddleware                      │
│ - Проверка роли (judge или admin)   │
│ - Отказ если player                 │
└──────────────┬──────────────────────┘
               │
               ↓
┌─────────────────────────────────────┐
│ Handler: judge_tickets_menu         │
│ - Показывает фильтры                │
│ - Открытые / В работе / Все         │
└──────────────┬──────────────────────┘
               │
               ↓ [Выбирает "Открытые"]
               │
┌─────────────────────────────────────┐
│ Database.get_all_tickets(status)    │
│ - SELECT WHERE status='open'        │
│ - ORDER BY created_at DESC          │
└──────────────┬──────────────────────┘
               │
               ↓
┌─────────────────────────────────────┐
│ Handler: judge_filter_tickets       │
│ - Список заявок с inline кнопками   │
│ - Для каждой: emoji + #id + тип     │
└──────────────┬──────────────────────┘
               │
               ↓ [Выбирает заявку #5]
               │
┌─────────────────────────────────────┐
│ Database.get_ticket(5)              │
│ Database.get_user(ticket.user_id)   │
│ Database.get_ticket_comments(5)     │
└──────────────┬──────────────────────┘
               │
               ↓
┌─────────────────────────────────────┐
│ Handler: judge_view_ticket          │
│ - Полная информация                 │
│ - Контакт игрока                    │
│ - История комментариев              │
│ - Кнопки действий:                  │
│   • Взять в работу                  │
│   • Добавить комментарий            │
│   • Закрыть заявку                  │
└──────────────┬──────────────────────┘
               │
               ↓ [Взять в работу]
               │
┌─────────────────────────────────────┐
│ Database.update_ticket_status()     │
│ - status = 'in_progress'            │
└──────────────┬──────────────────────┘
               │
               ↓
┌─────────────────────────────────────┐
│ Database.create_comment()           │
│ - Автокомментарий о взятии в работу │
└──────────────┬──────────────────────┘
               │
               ↓
┌──────────────────────────┐
│ Уведомление игроку:      │
│ 🟡 Заявка взята в работу │
│    судьей Алексей        │
└──────────────────────────┘
               │
               ↓ [Добавляет комментарий]
               │
┌─────────────────────────────────────┐
│ FSM: CommentForm.entering_comment   │
│ - Ожидает текст комментария         │
│ - Валидация (3-500 символов)        │
└──────────────┬──────────────────────┘
               │
               ↓ [Вводит комментарий]
               │
┌─────────────────────────────────────┐
│ Database.create_comment()           │
│ - INSERT INTO comments              │
└──────────────┬──────────────────────┘
               │
               ↓
┌──────────────────────────┐
│ Уведомление игроку:      │
│ 💬 Новый комментарий     │
│    Судья: [текст]        │
└──────────────────────────┘
               │
               ↓ [Закрывает заявку]
               │
┌─────────────────────────────────────┐
│ Database.update_ticket_status()     │
│ - status = 'closed'                 │
│ - closed_at = NOW()                 │
│ - closed_by = judge_id              │
└──────────────┬──────────────────────┘
               │
               ↓
┌──────────────────────────┐
│ Уведомление игроку:      │
│ 🔒 Заявка закрыта        │
│    судьей Алексей        │
└──────────────────────────┘
```

---

## 🔑 Управление судьями (Админ)

```
┌─────────────────┐
│  Администратор  │
│ (Первый user)   │
└────────┬────────┘
         │
         ↓ /add_judge @ivan
         │
┌────────────────────────────────────┐
│ RoleMiddleware                     │
│ - Проверка роли = admin            │
│ - Отказ если player или judge      │
└────────┬───────────────────────────┘
         │
         ↓
┌────────────────────────────────────┐
│ Handler: add_judge                 │
│ - Парсинг username из команды      │
│ - Удаление @ если есть             │
└────────┬───────────────────────────┘
         │
         ↓
┌────────────────────────────────────┐
│ Database.get_user_by_username()    │
│ - SELECT WHERE username='ivan'     │
└────────┬───────────────────────────┘
         │
         ↓ [User найден]
         │
┌────────────────────────────────────┐
│ Database.update_user_role()        │
│ - UPDATE users SET role='judge'    │
└────────┬───────────────────────────┘
         │
         ↓
    ┌────┴────┐
    │         │
    ↓         ↓
┌────────┐  ┌──────────────┐
│ Админу │  │ Новому судье │
│ ✅ OK  │  │ 🎉 Вы судья  │
└────────┘  └──────────────┘
```

---

## ⏰ Автоматическое закрытие

```
┌──────────────────────────┐
│  APScheduler             │
│  Каждый час              │
└────────┬─────────────────┘
         │
         ↓
┌────────────────────────────────────┐
│ TicketScheduler.close_old_tickets()│
└────────┬───────────────────────────┘
         │
         ↓
┌────────────────────────────────────┐
│ Database.get_old_open_tickets(3)   │
│ SELECT WHERE:                      │
│  - status IN ('open','in_progress')│
│  - created_at < NOW() - 3 days     │
└────────┬───────────────────────────┘
         │
         ↓
  ┌──────┴──────┐
  │ Для каждой: │
  └──────┬──────┘
         │
         ↓
┌────────────────────────────────────┐
│ Database.update_ticket_status()    │
│ - status = 'closed'                │
│ - closed_by = NULL (система)       │
└────────┬───────────────────────────┘
         │
         ↓
┌────────────────────────────────────┐
│ Database.create_comment()          │
│ - Системный комментарий            │
│ - "Автоматически закрыта..."       │
└────────┬───────────────────────────┘
         │
         ↓
    ┌────┴────┐
    │         │
    ↓         ↓
┌────────┐  ┌──────────┐
│ Игроку │  │ Судьям   │
│ 🔒     │  │ 🔒       │
│ Авто-  │  │ Заявка   │
│ закрыта│  │ закрыта  │
└────────┘  └──────────┘
```

---

## 🗄️ Структура базы данных

```
┌─────────────────────────────────────┐
│            users                    │
├─────────────────────────────────────┤
│ id           INTEGER PRIMARY KEY    │
│ username     TEXT                   │
│ first_name   TEXT NOT NULL          │
│ role         TEXT DEFAULT 'player'  │
│ created_at   TIMESTAMP              │
└──────────────┬──────────────────────┘
               │
               │ 1:N
               │
┌──────────────┴──────────────────────┐
│            tickets                  │
├─────────────────────────────────────┤
│ id           INTEGER PRIMARY KEY    │
│ user_id      INTEGER FK → users     │
│ ticket_type  TEXT NOT NULL          │
│ description  TEXT NOT NULL          │
│ status       TEXT DEFAULT 'open'    │
│ created_at   TIMESTAMP              │
│ closed_at    TIMESTAMP              │
│ closed_by    INTEGER FK → users     │
└──────────────┬──────────────────────┘
               │
               │ 1:N
               │
┌──────────────┴──────────────────────┐
│           comments                  │
├─────────────────────────────────────┤
│ id           INTEGER PRIMARY KEY    │
│ ticket_id    INTEGER FK → tickets   │
│ judge_id     INTEGER FK → users     │
│ text         TEXT NOT NULL          │
│ created_at   TIMESTAMP              │
└─────────────────────────────────────┘
```

---

## 🎭 Роли и доступ

```
┌──────────────────────────────────────────────────────┐
│                      PLAYER                          │
│  • Создание жалоб                                    │
│  • Просмотр СВОИХ заявок                             │
│  • Закрытие СВОИХ заявок                             │
└──────────────────────────────────────────────────────┘
                          │
                          │ Повышение до
                          ↓
┌──────────────────────────────────────────────────────┐
│                      JUDGE                           │
│  • Всё, что может Player                             │
│  • Просмотр ВСЕХ заявок                              │
│  • Фильтрация заявок                                 │
│  • Взятие в работу                                   │
│  • Комментарии к заявкам                             │
│  • Закрытие ЛЮБЫХ заявок                             │
│  • Просмотр контактов игроков                        │
└──────────────────────────────────────────────────────┘
                          │
                          │ Первый пользователь
                          ↓
┌──────────────────────────────────────────────────────┐
│                      ADMIN                           │
│  • Всё, что может Judge                              │
│  • Добавление судей (/add_judge)                     │
│  • Удаление судей (/remove_judge)                    │
│  • Список судей (/list_judges)                       │
└──────────────────────────────────────────────────────┘
```

---

## 📊 Жизненный цикл заявки

```
        СОЗДАНИЕ
           │
           ↓
    ┌──────────────┐
    │     OPEN     │  🟢 Открыта
    │  (открыта)   │
    └──────┬───────┘
           │
           │ [Судья берет в работу]
           ↓
    ┌──────────────┐
    │ IN_PROGRESS  │  🟡 В работе
    │  (в работе)  │
    └──────┬───────┘
           │
      ┌────┴────┐
      │         │
      │         │ [Через 3 дня]
      │         │ [Авто-закрытие]
      │         ↓
      │    ┌─────────┐
      │    │ CLOSED  │  ⚫ Закрыта
      │    │(закрыта)│  (системой)
      │    └─────────┘
      │
      │ [Судья закрывает]
      │ [Игрок закрывает]
      ↓
    ┌──────────────┐
    │    CLOSED    │  ⚫ Закрыта
    │  (закрыта)   │  (вручную)
    └──────────────┘
```

---

## 🔐 Middleware Pipeline

```
Запрос от пользователя
         │
         ↓
┌────────────────────┐
│  AuthMiddleware    │  ← Проверка/создание user
└─────────┬──────────┘
          │ [user добавлен в context]
          ↓
┌────────────────────┐
│ RateLimitMiddleware│  ← Проверка лимита запросов
└─────────┬──────────┘
          │ [OK, в пределах лимита]
          ↓
┌────────────────────┐
│  RoleMiddleware    │  ← Проверка роли (если нужно)
└─────────┬──────────┘
          │ [Роль подходит]
          ↓
┌────────────────────┐
│     HANDLER        │  ← Обработка команды
└────────────────────┘
```

---

## 📱 Пример UI (Inline клавиатуры)

### Главное меню (Игрок)
```
┌─────────────────────────────────┐
│ 👋 Добро пожаловать, Иван!       │
│                                  │
│ Это бот для обработки жалоб...   │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  📝 Создать жалобу               │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  📋 Мои заявки                   │
└─────────────────────────────────┘
```

### Главное меню (Судья)
```
┌─────────────────────────────────┐
│ 👋 Добро пожаловать, Алексей!    │
│ 👨‍⚖️ Вы - судья турнира.           │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  📝 Создать жалобу               │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  📋 Мои заявки                   │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  👨‍⚖️ Все заявки                  │
└─────────────────────────────────┘
```

### Выбор типа жалобы
```
┌─────────────────────────────────┐
│ 📝 Создание жалобы               │
│                                  │
│ Выберите тип жалобы:             │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  🔄 Перенос матча                │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  ⚠️ Жалоба на соперников         │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  ❓ Помощь в проблеме             │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  « Назад                         │
└─────────────────────────────────┘
```

### Список заявок (Судья)
```
┌─────────────────────────────────┐
│ 📋 Открытые заявки (3):          │
│                                  │
│ Выберите заявку:                 │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  🟢 #1 - Жалоба на соперников    │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  🟢 #2 - Перенос матча           │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  🟢 #3 - Помощь в проблеме       │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  « Назад                         │
└─────────────────────────────────┘
```

### Действия судьи с заявкой
```
┌─────────────────────────────────┐
│ 📋 Заявка #1                     │
│                                  │
│ 👤 Игрок: Иван (@ivan_player)    │
│ 📞 Контакт: @ivan_player         │
│                                  │
│ 📌 Тип: Жалоба на соперников     │
│ 📊 Статус: Открыта               │
│ 📅 Создана: 2025-10-26 18:30     │
│ 📝 Описание:                     │
│ Команда противника использовала  │
│ читы...                          │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  ✋ Взять в работу                │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  💬 Добавить комментарий         │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  🔒 Закрыть заявку               │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  « Назад к списку                │
└─────────────────────────────────┘
```

---

## 📊 Статистика проекта

```
┌──────────────────────────────────────┐
│  ФАЙЛЫ                               │
│  • Python модулей: 14                │
│  • Markdown документов: 11           │
│  • Конфигурационных: 3               │
│  ИТОГО: 28 файлов                    │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│  КОД                                 │
│  • Строк кода: ~1500                 │
│  • Функций/методов: 50+              │
│  • Классов: 8                        │
│  • Middleware: 3                     │
│  • FSM состояний: 4                  │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│  БАЗА ДАННЫХ                         │
│  • Таблиц: 3                         │
│  • Индексов: 3                       │
│  • CRUD операций: 20+                │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│  ДОКУМЕНТАЦИЯ                        │
│  • Страниц: ~150                     │
│  • Примеров: 20+                     │
│  • FAQ вопросов: 50+                 │
└──────────────────────────────────────┘
```

---

**Визуальное руководство создано для быстрого понимания архитектуры и потоков данных**

*Дата: 26 октября 2025*

