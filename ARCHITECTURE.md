# Архитектура CS2 Judge Bot

## Обзор

CS2 Judge Bot - это Telegram бот для управления жалобами игроков во время турниров CS2. Бот построен на современном асинхронном фреймворке aiogram 3.x с использованием SQLite для хранения данных.

## Технологический стек

- **Python 3.10+** - основной язык программирования
- **aiogram 3.13+** - асинхронная библиотека для Telegram Bot API
- **aiosqlite** - асинхронный драйвер для SQLite
- **APScheduler** - планировщик задач для автоматических операций
- **python-dotenv** - управление конфигурацией через переменные окружения

## Архитектурные решения

### 1. Асинхронная архитектура

Весь код написан с использованием async/await для максимальной производительности:
- Неблокирующие операции с базой данных (aiosqlite)
- Параллельная обработка запросов от пользователей
- Эффективная работа scheduler'а

### 2. FSM (Finite State Machine)

Для управления диалогами используется FSM из aiogram:
- `TicketForm` - состояния создания жалобы (выбор типа → описание → подтверждение)
- `CommentForm` - состояния добавления комментария

Преимущества:
- Четкое управление контекстом разговора
- Защита от неправильного порядка действий
- Сохранение промежуточных данных между шагами

### 3. Middleware система

Три уровня middleware для обработки запросов:

#### AuthMiddleware
- Автоматическая регистрация новых пользователей
- Проверка существования пользователя в БД
- Добавление объекта user в контекст handlers

#### RoleMiddleware
- Проверка прав доступа (player/judge/admin)
- Блокировка несанкционированного доступа
- Параметризуемая по требуемой роли

#### RateLimitMiddleware
- Защита от спама
- Ограничение количества запросов в единицу времени
- Отдельный счетчик для каждого пользователя

### 4. Модульная структура handlers

Handlers разделены по ролям:
- `player.py` - доступно всем пользователям
- `judge.py` - только для судей и админов (через RoleMiddleware)
- `admin.py` - только для админов (через RoleMiddleware)

## Структура базы данных

### Таблицы

#### users
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY,              -- Telegram user ID
    username TEXT,                       -- Telegram username (может отсутствовать)
    first_name TEXT NOT NULL,           -- Имя пользователя
    role TEXT NOT NULL DEFAULT 'player',-- Роль: player/judge/admin
    created_at TIMESTAMP                -- Дата регистрации
)
```

#### tickets
```sql
CREATE TABLE tickets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,           -- Создатель заявки
    ticket_type TEXT NOT NULL,          -- Тип жалобы
    description TEXT NOT NULL,          -- Описание проблемы
    status TEXT NOT NULL DEFAULT 'open',-- Статус: open/in_progress/closed
    created_at TIMESTAMP,               -- Дата создания
    closed_at TIMESTAMP,                -- Дата закрытия
    closed_by INTEGER,                  -- Кто закрыл (user_id или NULL для системы)
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (closed_by) REFERENCES users(id)
)
```

#### comments
```sql
CREATE TABLE comments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ticket_id INTEGER NOT NULL,         -- К какой заявке
    judge_id INTEGER NOT NULL,          -- Кто оставил комментарий
    text TEXT NOT NULL,                 -- Текст комментария
    created_at TIMESTAMP,               -- Дата создания
    FOREIGN KEY (ticket_id) REFERENCES tickets(id),
    FOREIGN KEY (judge_id) REFERENCES users(id)
)
```

### Индексы

Для оптимизации производительности созданы индексы:
- `idx_tickets_user_id` - для быстрого поиска заявок пользователя
- `idx_tickets_status` - для фильтрации по статусу
- `idx_comments_ticket_id` - для загрузки комментариев к заявке

## Потоки данных

### Создание жалобы

```
Пользователь: /start → Создать жалобу
    ↓
FSM: TicketForm.choosing_type
    ↓ (пользователь выбирает тип)
FSM: TicketForm.entering_description
    ↓ (пользователь вводит текст)
Валидация: длина, содержимое
    ↓
FSM: TicketForm.confirming
    ↓ (пользователь подтверждает)
БД: создание записи в tickets
    ↓
Уведомления: всем судьям
```

### Обработка заявки судьей

```
Судья: Все заявки → Фильтр (открытые)
    ↓
БД: SELECT * FROM tickets WHERE status='open'
    ↓
Судья: выбирает заявку
    ↓
БД: SELECT ticket + comments + user
    ↓
Судья: Взять в работу
    ↓
БД: UPDATE tickets SET status='in_progress'
БД: INSERT INTO comments (автокомментарий)
    ↓
Уведомление: игроку о взятии в работу
```

### Автоматическое закрытие

```
Scheduler: каждый час
    ↓
БД: SELECT tickets WHERE 
    status IN ('open', 'in_progress')
    AND created_at < NOW() - 3 days
    ↓
Для каждой найденной заявки:
    - UPDATE status='closed'
    - INSERT comment (системный)
    - Уведомление игроку
    - Уведомление всем судьям
```

## Безопасность

### 1. Валидация входных данных

```python
# config.py
MAX_DESCRIPTION_LENGTH = 1000  # Максимум для описания жалобы
MAX_COMMENT_LENGTH = 500       # Максимум для комментария
```

Проверка происходит в handlers перед сохранением в БД.

### 2. SQL Injection защита

Все запросы используют параметризацию:
```python
await db.execute(
    "SELECT * FROM users WHERE id = ?", 
    (user_id,)  # Параметр, а не конкатенация строк
)
```

### 3. Разграничение доступа

Иерархия ролей:
```
admin > judge > player
```

- Player: видит только свои заявки
- Judge: видит все заявки, может обрабатывать
- Admin: может управлять судьями + все права судьи

### 4. Rate Limiting

```python
# Структура в памяти
user_requests = {
    user_id: [timestamp1, timestamp2, ...]
}

# При каждом запросе:
# 1. Удаляем старые timestamp'ы (> 60 сек)
# 2. Проверяем количество оставшихся
# 3. Если >= 10, блокируем
# 4. Иначе добавляем новый timestamp
```

### 5. Безопасное хранение токена

- Токен в `.env` файле
- `.env` в `.gitignore`
- Никогда не попадает в git репозиторий

## Масштабируемость

### Текущие ограничения (SQLite)

- Одновременная запись: ~10-50 в секунду
- Размер БД: рекомендуется до 1-2 GB
- Подходит для: 100-500 активных пользователей

### Миграция на PostgreSQL

Для масштабирования можно перейти на PostgreSQL:
1. Заменить `aiosqlite` на `asyncpg`
2. Изменить SQL синтаксис (минимально)
3. Настроить connection pool
4. Выдержит 10,000+ пользователей

### Горизонтальное масштабирование

Для очень больших нагрузок:
- Несколько экземпляров бота за load balancer'ом
- Общая PostgreSQL БД
- Redis для shared state (FSM context)
- Separate scheduler instance

## Мониторинг и логирование

### Уровни логов

```python
logger.info()    # Обычные операции
logger.warning() # Подозрительные события
logger.error()   # Ошибки с fallback
```

### Что логируется

- Создание/закрытие заявок
- Изменение ролей пользователей
- Ошибки отправки уведомлений
- Rate limit превышения
- Автоматическое закрытие заявок

### Формат логов

```
2025-10-26 19:00:00 - module.name - LEVEL - Message
```

## Тестирование

### Рекомендуемая стратегия

1. **Unit тесты**
   - Функции валидации
   - CRUD операции БД
   - Middleware логика

2. **Integration тесты**
   - Полные потоки (создание → обработка → закрытие)
   - FSM переходы
   - Scheduler jobs

3. **Manual тесты**
   - UI/UX проверка
   - Уведомления
   - Edge cases

## Будущие улучшения

### Возможные расширения

1. **Статистика**
   - Количество заявок по типам
   - Среднее время обработки
   - Рейтинг судей

2. **Расширенные роли**
   - Senior judge (может управлять обычными судьями)
   - Модератор (только просмотр)

3. **Интеграция**
   - Webhooks для внешних систем
   - API для веб-интерфейса
   - Экспорт данных в Excel

4. **Улучшения UX**
   - Кнопки inline вместо команд
   - Фото/видео в жалобах
   - Шаблоны для частых проблем

5. **Безопасность**
   - 2FA для админов
   - Аудит лог всех действий
   - Шифрование чувствительных данных

## Производительность

### Оптимизации

1. **База данных**
   - Индексы на часто используемых полях
   - Limit на запросах списков
   - Кэширование судей в памяти (опционально)

2. **Код**
   - Async везде
   - Минимум блокирующих операций
   - Batch уведомления судьям

3. **Telegram API**
   - Повторные попытки при ошибках
   - Graceful degradation при недоступности

### Метрики

Примерная производительность на обычном VPS:
- 100+ запросов/сек
- < 100ms ответ на команду
- 1000+ активных пользователей
- 10,000+ заявок в БД без деградации

## Заключение

Архитектура бота построена с учетом:
- **Безопасности** - многоуровневая защита
- **Масштабируемости** - готовность к росту
- **Поддерживаемости** - чистый модульный код
- **Надежности** - обработка ошибок, логирование
- **Производительности** - async, индексы, оптимизации

