# Руководство по развертыванию CS2 Judge Bot

## Системные требования

- Python 3.10 или выше
- pip (менеджер пакетов Python)
- Telegram аккаунт для создания бота

## Пошаговая инструкция

### 1. Создание бота в Telegram

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям:
   - Введите имя бота (например: "CS2 Judge Bot")
   - Введите username бота (должен заканчиваться на "bot", например: "cs2judge_bot")
4. Скопируйте полученный токен (выглядит как `1234567890:ABCdefGHIjklMNOpqrsTUVwxyz`)

### 2. Установка зависимостей

```bash
# Установите все необходимые пакеты
pip install -r requirements.txt
```

### 3. Настройка конфигурации

1. Откройте файл `.env` в текстовом редакторе
2. Замените `your_bot_token_here` на токен, полученный от BotFather:
   ```
   BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
   ```
3. При необходимости измените другие настройки:
   - `AUTO_CLOSE_DAYS` - через сколько дней закрывать неактивные заявки (по умолчанию 3)
   - `RATE_LIMIT_MAX_REQUESTS` - максимум запросов в минуту (защита от спама)

### 4. Запуск бота

```bash
python main.py
```

Вы должны увидеть сообщение:
```
Bot started successfully!
```

### 5. Первый запуск

1. Найдите вашего бота в Telegram по username
2. Отправьте команду `/start`
3. **Важно:** Первый пользователь, который запустит бота, автоматически станет администратором

### 6. Добавление судей

Как администратор, вы можете назначать судей:

```
/add_judge @username
```

Пример:
```
/add_judge @ivan_referee
```

**Важно:** Пользователь должен сначала запустить бота командой `/start`, чтобы его можно было назначить судьей.

## Управление ботом

### Команды администратора

- `/add_judge @username` - Назначить пользователя судьей
- `/remove_judge @username` - Снять судью с должности
- `/list_judges` - Показать список всех судей

### Работа судьи

Судьи могут:
1. Просматривать все заявки (фильтры: открытые, в работе, все)
2. Брать заявки в работу
3. Добавлять комментарии к заявкам
4. Закрывать заявки
5. Видеть контакты игроков для связи

### Работа игроков

Игроки могут:
1. Создавать жалобы трех типов:
   - Перенос матча
   - Жалоба на соперников
   - Помощь в проблеме
2. Просматривать свои заявки
3. Закрывать свои заявки

## Автоматизация

### Автоматическое закрытие заявок

Бот автоматически закрывает заявки, которые:
- Открыты или находятся в работе
- Созданы более 3 дней назад (настраивается через `AUTO_CLOSE_DAYS`)

Проверка происходит каждый час.

При автозакрытии:
- Игрок получает уведомление
- Судьи получают уведомление
- В заявку добавляется системный комментарий

## Безопасность

### Защита от спама

- Rate limiting: максимум 10 запросов в минуту на пользователя
- Валидация длины текста:
  - Описание жалобы: до 1000 символов
  - Комментарий: до 500 символов

### Разделение прав доступа

- **Игроки** видят только свои заявки
- **Судьи** видят все заявки и могут их обрабатывать
- **Админы** могут управлять судьями + имеют все права судей

### Рекомендации

1. Не делитесь токеном бота
2. Файл `.env` не должен попадать в систему контроля версий (уже добавлен в `.gitignore`)
3. Регулярно делайте резервные копии базы данных (`bot.db`)
4. Следите за логами в файле `bot.log`

## Остановка бота

Нажмите `Ctrl+C` в терминале, где запущен бот.

## Обновление бота

После изменения кода:
1. Остановите бота (`Ctrl+C`)
2. Запустите снова: `python main.py`

База данных сохраняется и все данные остаются.

## Проблемы и решения

### Бот не запускается

1. Проверьте, что токен правильно указан в `.env`
2. Проверьте, что все зависимости установлены: `pip install -r requirements.txt`
3. Проверьте логи в `bot.log`

### Не могу назначить судью

1. Убедитесь, что пользователь запустил бота командой `/start`
2. Проверьте правильность написания username (с @ в начале)
3. Убедитесь, что вы администратор

### Заявки не закрываются автоматически

1. Проверьте настройку `AUTO_CLOSE_DAYS` в `.env`
2. Убедитесь, что бот запущен непрерывно
3. Проверьте логи - автозакрытие происходит каждый час

## Бэкап базы данных

```bash
# Windows
copy bot.db bot.db.backup

# Linux/Mac
cp bot.db bot.db.backup
```

## Мониторинг

Логи записываются в два места:
1. Консоль (stdout)
2. Файл `bot.log`

Формат лога:
```
2025-10-26 19:00:00 - module_name - INFO - Message
```

## Производственное развертывание

Для продакшн-среды рекомендуется:
1. Использовать systemd (Linux) или PM2 для автоперезапуска
2. Настроить ротацию логов
3. Использовать PostgreSQL вместо SQLite для высоких нагрузок
4. Настроить мониторинг и алерты

Пример systemd service:
```ini
[Unit]
Description=CS2 Judge Bot
After=network.target

[Service]
Type=simple
User=botuser
WorkingDirectory=/path/to/bot
ExecStart=/usr/bin/python3 main.py
Restart=always

[Install]
WantedBy=multi-user.target
```

## Поддержка

При возникновении проблем проверьте:
1. Логи в `bot.log`
2. Консольный вывод
3. Базу данных `bot.db` (можно открыть через SQLite Browser)

